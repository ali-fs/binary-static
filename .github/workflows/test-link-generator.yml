name: Binary Test Link and App ID Generator

on: [pull_request]

jobs:
  generate_app_id:
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Generate Binary App ID for deployment Preview URL
        id: generate_app_id
        uses: ali-fs/binary-app-id-action@master
        with:
          BINARY_API_TOKEN: ${{ secrets.BINARY_API_TOKEN }}
          BINARY_APP_ID: ${{ secrets.BINARY_APP_ID }},
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          max_retries: 5
      - name: git-log
        id: gitlog
        run: |
          git status
          pwd
          ls
      - name: Deploy branch on gh-pages
        id: deploy
        run: |
          npm i
          ${GITHUB_WORKSPACE}/node_modules/grunt/bin/grunt dev --branch=${{ steps.generate_app_id.outputs.new_branch_name }}
      - name: Comment on pull request with App ID and URLs
        id: sticky_comment_on_pr
        if: steps.generate_app_id.outputs.should_post_comment
        uses: marocchino/sticky-pull-request-comment@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: binary-app-id-action
          number: ${{github.event.issue.number}}
          message: |
            A production App ID was automatically generated for this PR. ([log](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}))

            - **PR**: [${{ steps.generate_app_id.outputs.pr_url }}](${{ steps.generate_app_id.outputs.pr_url }})
            - **URL**: [https://ali-fs.github.io/binary-static/br_${{ steps.generate_app_id.outputs.new_branch_name }}/en/logged_inws.html](https://ali-fs.github.io/binary-static/br_${{ steps.generate_app_id.outputs.new_branch_name }}/en/logged_inws.html)
            - **App ID**: `${{ steps.generate_app_id.outputs.app_id }}`

            <details>
              <summary>Copy/paste snippet</summary>

              ```
              - **PR**: [${{ steps.generate_app_id.outputs.pr_url }}](${{ steps.generate_app_id.outputs.pr_url }})
              - **URL**: [https://ali-fs.github.io/binary-static/br_${{ steps.generate_app_id.outputs.new_branch_name }}/en/logged_inws.html](https://ali-fs.github.io/binary-static/br_${{ steps.generate_app_id.outputs.new_branch_name }}/en/logged_inws.html)
              - **App ID**: `${{ steps.generate_app_id.outputs.app_id }}`
              ```
            </details>
